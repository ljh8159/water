<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ì¹´ì¹´ì˜¤ ì§€ë„ ì‚­ì œ ê¸°ëŠ¥ í¬í•¨</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- âœ… autoload=false ì„¤ì • -->
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?autoload=false&appkey=f24f75617efd67a1234552d873c8373e&libraries=services"></script>
</head>
<body>
  <h2>ğŸ“ ì¹´ì¹´ì˜¤ ì§€ë„</h2>
  <div id="map"></div>
  <div id="coords">ğŸ§­ í´ë¦­í•œ ìœ„ì¹˜ì˜ ì¢Œí‘œì™€ ì£¼ì†Œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>

  <script>
    window.onload = function () {
      kakao.maps.load(function () {
        const mapContainer = document.getElementById('map'),
              mapOption = {
                center: new kakao.maps.LatLng(37.5665, 126.9780),
                level: 3
              };

        const map = new kakao.maps.Map(mapContainer, mapOption);
        const geocoder = new kakao.maps.services.Geocoder();

        // ì €ì¥ëœ ì¢Œí‘œ ë§ˆì»¤
        fetch('/get_coords')
          .then(res => res.json())
          .then(data => {
            data.forEach(item => {
              const pos = new kakao.maps.LatLng(item.lat, item.lng);
              const marker = new kakao.maps.Marker({ position: pos, map: map });
              const infowindow = new kakao.maps.InfoWindow({ content: `<div>${item.address}</div>` });

              kakao.maps.event.addListener(marker, 'click', () => {
                if (confirm("ì´ ë§ˆì»¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                  fetch('/delete_coords', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ lat: item.lat, lng: item.lng })
                  }).then(() => marker.setMap(null));
                } else {
                  infowindow.open(map, marker);
                }
              });
            });
          });

        // í´ë¦­ ì‹œ ë§ˆì»¤ ì €ì¥
        kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
          const latlng = mouseEvent.latLng;
          if (!confirm("ì´ ìœ„ì¹˜ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

          geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
            if (status === kakao.maps.services.Status.OK) {
              const address = result[0].address.address_name;

              document.getElementById('coords').innerHTML =
                `ğŸ“Œ ìœ„ë„: ${latlng.getLat()}, ê²½ë„: ${latlng.getLng()}<br>ğŸ  ì£¼ì†Œ: ${address}`;

              fetch('/save_coords', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  lat: latlng.getLat(),
                  lng: latlng.getLng(),
                  address: address
                })
              }).then(() => {
                const marker = new kakao.maps.Marker({ position: latlng, map: map });
                const infowindow = new kakao.maps.InfoWindow({ content: `<div>${address}</div>` });

                kakao.maps.event.addListener(marker, 'click', () => {
                  if (confirm("ì´ ë§ˆì»¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    fetch('/delete_coords', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ lat: latlng.getLat(), lng: latlng.getLng() })
                    }).then(() => marker.setMap(null));
                  } else {
                    infowindow.open(map, marker);
                  }
                });
              });
            }
          });
        });
      });
    };
  </script>
</body>
</html>
