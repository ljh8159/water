<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ì¹´ì¹´ì˜¤ ì§€ë„ ì‚­ì œ ê¸°ëŠ¥ í¬í•¨</title>
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=f3431dbe0250d319e254837045e1ef8a&libraries=services"></script>
  <style>
    #map {
      width: 100%;
      height: 500px;
    }
    #coords {
      margin-top: 15px;
      font-size: 16px;
    }
  </style>
</head>
<body>
  <h2>ğŸ“ ì¹´ì¹´ì˜¤ ì§€ë„</h2>
  <div id="map"></div>
  <div id="coords">ğŸ§­ í´ë¦­í•œ ìœ„ì¹˜ì˜ ì¢Œí‘œì™€ ì£¼ì†Œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>

  <script>
    const mapContainer = document.getElementById('map'),
          mapOption = {
            center: new kakao.maps.LatLng(37.5665, 126.9780),
            level: 3
          };

    const map = new kakao.maps.Map(mapContainer, mapOption);
    const geocoder = new kakao.maps.services.Geocoder();

    // âœ… ì €ì¥ëœ ì¢Œí‘œë“¤ ë¶ˆëŸ¬ì™€ ë§ˆì»¤ í‘œì‹œ
    fetch('/get_coords')
      .then(res => res.json())
      .then(data => {
        data.forEach(item => {
          const pos = new kakao.maps.LatLng(item.lat, item.lng);
          const savedMarker = new kakao.maps.Marker({
            position: pos,
            map: map
          });

          const infowindow = new kakao.maps.InfoWindow({
            content: `<div style="font-size:13px; padding:5px;">${item.address || 'ì£¼ì†Œ ì—†ìŒ'}</div>`
          });

          kakao.maps.event.addListener(savedMarker, 'click', () => {
            if (confirm("ì´ ë§ˆì»¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
              fetch('/delete_coords', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ lat: item.lat, lng: item.lng })
              }).then(res => res.json()).then(() => {
                savedMarker.setMap(null); // ì§€ë„ì—ì„œ ë§ˆì»¤ ì‚­ì œ
              });
            } else {
              infowindow.open(map, savedMarker);
            }
          });
        });
      });

    // âœ… í´ë¦­í•œ ì¢Œí‘œ ì €ì¥
    kakao.maps.event.addListener(map, 'click', function(mouseEvent) {
      const latlng = mouseEvent.latLng;

      if (!confirm("ì´ ìœ„ì¹˜ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

      geocoder.coord2Address(latlng.getLng(), latlng.getLat(), function(result, status) {
        if (status === kakao.maps.services.Status.OK) {
          const address = result[0].address.address_name;

          document.getElementById('coords').innerHTML =
            `ğŸ“Œ ìœ„ë„: ${latlng.getLat().toFixed(6)}, ê²½ë„: ${latlng.getLng().toFixed(6)}<br>ğŸ  ì£¼ì†Œ: ${address}`;

          fetch('/save_coords', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              lat: latlng.getLat(),
              lng: latlng.getLng(),
              address: address
            })
          }).then(() => {
            const newMarker = new kakao.maps.Marker({
              position: latlng,
              map: map
            });

            const infowindow = new kakao.maps.InfoWindow({
              content: `<div style="font-size:13px; padding:5px;">${address}</div>`
            });

            kakao.maps.event.addListener(newMarker, 'click', () => {
              if (confirm("ì´ ë§ˆì»¤ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                fetch('/delete_coords', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    lat: latlng.getLat(),
                    lng: latlng.getLng()
                  })
                }).then(() => {
                  newMarker.setMap(null);
                });
              } else {
                infowindow.open(map, newMarker);
              }
            });
          });
        }
      });
    });
  </script>
</body>
</html>
